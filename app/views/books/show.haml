%h3 #{@book.title}
%p By: #{@book.author}

%h5 Cover Image
- if @book.cover_image.attached?
  = image_tag @book.cover_image
- else
  %p No image

%p Book type: #{@book.book_type}
%p Active: #{@book.active}
%p Reference Number: #{@book.reference_number}
%p Edition: #{@book.edition}

- if @loan.present?
  %h2 About your loan
  %p Borrowed at: #{@loan.borrowed_at.strftime("%d/%m/%Y %T")}
  - if @loan.renewed_at != nil
    %p Renewed at: #{@loan.renewed_at.strftime("%d/%m/%Y %T")}
  %p Returned at: #{@loan.returned_at}
  %p To be returned at: #{@loan.to_be_returned_at.strftime("%d/%m/%Y %T")}
  - if @book.content.attached?
    = link_to 'Read', url_for(@book.content), target: '_blank', class: 'btn btn-info'
    = link_to 'Download', rails_blob_path(@book.content, disposition: 'attachment'), target: '_blank',
      class: 'btn btn-secondary'
  = link_to 'Return book', book_return_path(@book), class: 'btn btn-primary'
  = link_to 'Renew book', book_renew_path(@book), class: 'btn btn-primary'

- else
  - if current_user.student?
    = link_to 'Borrow book', students_borrow_book_path(@book)
  - elsif current_user.staff?
    = link_to 'Borrow book', staff_borrow_book_path(@book)

%br
%br

- if current_user.library_manager?
  %h2 Loan History
  %table
    %thead
      %tr 
        %th User ID
        %th Borrow date
        %th Return date
        %th Late return
        %th Fine
    %tbody
    - @book.loans.each do |loan| 
      %tr
        %td= loan.user.id
        %td= loan.borrowed_at.strftime("%d/%m/%Y")
        - if loan.returned_at == nil
          %td= "Book still borrowed"
          %td N/A
          %td N/A
        - else
          %td= loan.returned_at.strftime("%d/%m/%Y")
          - if loan.returned_at < loan.to_be_returned_at
            %td No
            %td N/A
          - else 
            %td Yes
            - if loan.fine.present?
              - if loan.fine.charged_at == nil 
                %td Amount: #{loan.fine.amount} - Unpaid
              - else 
                %td Amount: #{loan.fine.amount} - Paid
            - else 
              %td No fine

%br
%br

- if current_user.library_manager?
  = link_to 'Edit', edit_book_path(@book)
= link_to 'Back', books_path
